---
title: "éƒ¨ç½²å¤œæ™¯å¢å¼ºæ¨¡å‹Learning to See in the Darkä»¥åŠgradio UIç¼–ç¨‹æ–¹æ³•"
date: 2025-02-05
permalink: /posts/2025/02/blog-post-2/
tags:
- SID
- å¤œæ™¯å¢å¼º
---

å‰é¢æˆ‘ä»¬å·²ç»æŠŠLearning to See in the Darkçš„paperå’ŒåŸç†è¿›è¡Œäº†è§£è¯»ï¼Œç°åœ¨æŠŠLearning to See in the Darkï¼ˆåç»­ç®€ç§°SIDæ¨¡å‹ï¼‰éƒ¨ç½²çœ‹ä¸€ä¸‹æ•ˆæœã€‚

è¿™ç¯‡æ–‡ç« é€‰æ‹©çš„éƒ¨ç½²æ–¹å¼æ˜¯gradio + æœ¬åœ°pytorchç›´æ¥æ¨ç†ã€‚å…ˆçœ‹ä¸€ä¸‹æ•ˆæœï¼š

å¯¹å•ä¸ªæ–‡ä»¶è¿›è¡Œå¤œæ™¯å¢å¼ºï¼šï¼ˆgifåŠ è½½ç¨æ…¢ï¼Œå¯èƒ½è¦ç­‰ä¸€ä¸‹ï¼‰
![](https://borninfreedom.github.io/images/2025/02/sid/night_single.gif)

ä¾‹å¦‚ä¸‹é¢è¿™å¼ åŸºæœ¬å…¨é»‘çš„åŸå›¾ï¼Œç»è¿‡è¶…çº§å¤œæ™¯å¢å¼ºåŠŸèƒ½åï¼Œå‡ºå›¾å°±æ˜¯æ­£å¸¸çš„è§‚æ„Ÿã€‚

| åŸå›¾ | å¢å¼ºå |
| --- | --- |
| ![](https://borninfreedom.github.io/images/2025/02/sid/dsc_463.png) | ![](https://borninfreedom.github.io/images/2025/02/sid/dsc_463_enhance.png)  |


å¯¹ä¸€ä¸ªæ–‡ä»¶å¤¹å†…çš„å¤šä¸ªæ–‡ä»¶æ‰¹é‡è¿›è¡Œå¢å¼ºï¼šï¼ˆgifåŠ è½½ç¨æ…¢ï¼Œå¯èƒ½è¦ç­‰ä¸€ä¸‹ï¼‰
![](https://borninfreedom.github.io/images/2025/02/sid/night_batch.gif)

å¯¹äºå¤šæ–‡ä»¶çš„æ‰¹é‡å¤„ç†ï¼Œç”¨æˆ·å¯ä»¥ä¸Šä¼ æ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡ï¼Œç„¶åæ‰¹é‡è‡ªåŠ¨å¤„ç†ï¼Œåœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å½“å‰æ­£åœ¨å¤„ç†çš„ä¿¡æ¯å’Œè¿›åº¦ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°åŸå›¾å’Œå¤„ç†åçš„å¯¹æ¯”å›¾ã€‚
![](https://borninfreedom.github.io/images/2025/02/sid/5.png)


å½“å‰çš„éƒ¨ç½²æä¾›äº†ä¼˜ç¾æ˜“ç”¨çš„UIç•Œé¢ï¼Œè€Œä¸”å¤œæ™¯å¢å¼ºæ•ˆæœå¾ˆä¸é”™ã€‚æ•´ä¸ªé¡¹ç›®å¯ä»é“¾æ¥[image_toolbox](https://github.com/borninfreedom/image_toolbox/tree/main)æŸ¥çœ‹ã€‚

# ä¸€ã€sidçš„ç½‘ç»œç»“æ„

SeeInDark çš„ç»“æ„ç±»ä¼¼ U-Netï¼Œé€‚ç”¨äºä½å…‰ç…§å›¾åƒå¢å¼ºä»»åŠ¡ã€‚å®ƒé‡‡ç”¨äº† ç¼–ç -è§£ç ï¼ˆEncoder-Decoderï¼‰æ¶æ„ï¼Œé€šè¿‡ å·ç§¯å±‚ï¼ˆConvï¼‰+ ä¸‹é‡‡æ ·ï¼ˆPoolingï¼‰+ åå·ç§¯ï¼ˆUpConvï¼‰+ åƒç´ é‡æ’ï¼ˆPixel Shuffleï¼‰ æ¥å®ç°é«˜è´¨é‡çš„å›¾åƒå¢å¼ºã€‚

è¯¥ç½‘ç»œå¯åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š

* ç¼–ç ï¼ˆEncoderï¼‰ï¼šç”¨äºç‰¹å¾æå–
é€šè¿‡ å¤šä¸ª 3Ã—3 å·ç§¯ + Leaky ReLUï¼ˆLReLUï¼‰+ æœ€å¤§æ± åŒ–ï¼ˆMaxPoolï¼‰ æå–å›¾åƒçš„å±‚æ¬¡åŒ–ç‰¹å¾ã€‚
é‡‡ç”¨ 4 å±‚æ± åŒ–ï¼Œé€æ­¥é™ä½åˆ†è¾¨ç‡ï¼ŒåŒæ—¶å¢åŠ é€šé“æ•°ï¼Œè·å–æ›´ä¸°å¯Œçš„è¯­ä¹‰ä¿¡æ¯ã€‚
* è§£ç ï¼ˆDecoderï¼‰ï¼šç”¨äºæ¢å¤é«˜åˆ†è¾¨ç‡ä¿¡æ¯
é‡‡ç”¨ è½¬ç½®å·ç§¯ï¼ˆConvTranspose2dï¼‰+ è·³è·ƒè¿æ¥ï¼ˆSkip Connectionï¼‰+ å·ç§¯ é€æ­¥æ¢å¤é«˜åˆ†è¾¨ç‡ç‰¹å¾ã€‚
é€šè¿‡ è·³è·ƒè¿æ¥ï¼ˆskip connectionï¼‰ ç»“åˆä½å±‚ç»†èŠ‚ä¿¡æ¯ï¼Œå¢å¼ºé‡å»ºèƒ½åŠ›ï¼Œé¿å…ä¿¡æ¯ä¸¢å¤±ã€‚
* åƒç´ é‡æ’ï¼ˆPixel Shuffleï¼‰ï¼šæå‡åˆ†è¾¨ç‡
åœ¨è¾“å‡ºå±‚ ä½¿ç”¨ Pixel Shuffleï¼Œå°†é€šé“ä¿¡æ¯è½¬æ¢ä¸ºç©ºé—´ä¿¡æ¯ï¼Œå®ç° è¶…åˆ†è¾¨ç‡å¢å¼ºï¼Œæå‡æœ€ç»ˆå›¾åƒçš„æ¸…æ™°åº¦ã€‚


```python

class SeeInDark(nn.Module):
    def __init__(self, num_classes=10):
        super(SeeInDark, self).__init__()
        
        self.conv1_1 = nn.Conv2d(4, 32, kernel_size=3, stride=1, padding=1)
        self.conv1_2 = nn.Conv2d(32, 32, kernel_size=3, stride=1, padding=1)
        self.pool1 = nn.MaxPool2d(kernel_size=2)
        
        self.conv2_1 = nn.Conv2d(32, 64, kernel_size=3, stride=1, padding=1)
        self.conv2_2 = nn.Conv2d(64, 64, kernel_size=3, stride=1, padding=1)
        self.pool2 = nn.MaxPool2d(kernel_size=2)
        
        self.conv3_1 = nn.Conv2d(64, 128, kernel_size=3, stride=1, padding=1)
        self.conv3_2 = nn.Conv2d(128, 128, kernel_size=3, stride=1, padding=1)
        self.pool3 = nn.MaxPool2d(kernel_size=2)
        
        self.conv4_1 = nn.Conv2d(128, 256, kernel_size=3, stride=1, padding=1)
        self.conv4_2 = nn.Conv2d(256, 256, kernel_size=3, stride=1, padding=1)
        self.pool4 = nn.MaxPool2d(kernel_size=2)
        
        self.conv5_1 = nn.Conv2d(256, 512, kernel_size=3, stride=1, padding=1)
        self.conv5_2 = nn.Conv2d(512, 512, kernel_size=3, stride=1, padding=1)
        
        self.upv6 = nn.ConvTranspose2d(512, 256, 2, stride=2)
        self.conv6_1 = nn.Conv2d(512, 256, kernel_size=3, stride=1, padding=1)
        self.conv6_2 = nn.Conv2d(256, 256, kernel_size=3, stride=1, padding=1)
        
        self.upv7 = nn.ConvTranspose2d(256, 128, 2, stride=2)
        self.conv7_1 = nn.Conv2d(256, 128, kernel_size=3, stride=1, padding=1)
        self.conv7_2 = nn.Conv2d(128, 128, kernel_size=3, stride=1, padding=1)
        
        self.upv8 = nn.ConvTranspose2d(128, 64, 2, stride=2)
        self.conv8_1 = nn.Conv2d(128, 64, kernel_size=3, stride=1, padding=1)
        self.conv8_2 = nn.Conv2d(64, 64, kernel_size=3, stride=1, padding=1)
        
        self.upv9 = nn.ConvTranspose2d(64, 32, 2, stride=2)
        self.conv9_1 = nn.Conv2d(64, 32, kernel_size=3, stride=1, padding=1)
        self.conv9_2 = nn.Conv2d(32, 32, kernel_size=3, stride=1, padding=1)
        
        self.conv10_1 = nn.Conv2d(32, 12, kernel_size=1, stride=1)
    
    def forward(self, x):
        conv1 = self.lrelu(self.conv1_1(x))
        conv1 = self.lrelu(self.conv1_2(conv1))
        pool1 = self.pool1(conv1)
        
        conv2 = self.lrelu(self.conv2_1(pool1))
        conv2 = self.lrelu(self.conv2_2(conv2))
        pool2 = self.pool1(conv2)
        
        conv3 = self.lrelu(self.conv3_1(pool2))
        conv3 = self.lrelu(self.conv3_2(conv3))
        pool3 = self.pool1(conv3)
        
        conv4 = self.lrelu(self.conv4_1(pool3))
        conv4 = self.lrelu(self.conv4_2(conv4))
        pool4 = self.pool1(conv4)
        
        conv5 = self.lrelu(self.conv5_1(pool4))
        conv5 = self.lrelu(self.conv5_2(conv5))
        
        up6 = self.upv6(conv5)
        up6 = torch.cat([up6, conv4], 1)
        conv6 = self.lrelu(self.conv6_1(up6))
        conv6 = self.lrelu(self.conv6_2(conv6))
        
        up7 = self.upv7(conv6)
        up7 = torch.cat([up7, conv3], 1)
        conv7 = self.lrelu(self.conv7_1(up7))
        conv7 = self.lrelu(self.conv7_2(conv7))
        
        up8 = self.upv8(conv7)
        up8 = torch.cat([up8, conv2], 1)
        conv8 = self.lrelu(self.conv8_1(up8))
        conv8 = self.lrelu(self.conv8_2(conv8))
        
        up9 = self.upv9(conv8)
        up9 = torch.cat([up9, conv1], 1)
        conv9 = self.lrelu(self.conv9_1(up9))
        conv9 = self.lrelu(self.conv9_2(conv9))
        
        conv10= self.conv10_1(conv9)
        out = nn.functional.pixel_shuffle(conv10, 2)
        return out

    def _initialize_weights(self):
        for m in self.modules():
            if isinstance(m, nn.Conv2d):
                m.weight.data.normal_(0.0, 0.02)
                if m.bias is not None:
                    m.bias.data.normal_(0.0, 0.02)
            if isinstance(m, nn.ConvTranspose2d):
                m.weight.data.normal_(0.0, 0.02)

    def lrelu(self, x):
        outt = torch.max(0.2*x, x)
        return outt
```

sidçš„ç½‘ç»œç»“æ„ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œæ˜¯ä¸€ä¸ªUNetç»“æ„çš„ç½‘ç»œã€‚

ç½‘ç»œæ˜¯ä¸€ä¸ª4é€šé“çš„è¾“å…¥ï¼Œåœ¨ç½‘ç»œçš„å¼€å¤´ï¼Œé€šè¿‡ä½¿ç”¨kernel size=3, pad=1, stride=1çš„convï¼Œæ¥ä¿æŒäº†ç‰¹å¾å›¾å°ºå¯¸ä¸å˜ã€‚4é€šé“çš„è¾“å…¥æ¥è‡ªäºå°†rawå›¾çš„rggbè¿›è¡Œäº†æ‹†åˆ†ï¼Œæ‹†åˆ†åˆ°äº†4é€šé“ã€‚
```python
def pack_raw(raw,white_level,black_level):
    #pack Bayer image to 4 channels
    im = np.maximum(raw - black_level,0)/ (white_level - black_level) #subtract the black level

    im = np.expand_dims(im,axis=2) 
    img_shape = im.shape
    H = img_shape[0]
    W = img_shape[1]

    out = np.concatenate((im[0:H:2,0:W:2,:], 
                       im[0:H:2,1:W:2,:],
                       im[1:H:2,1:W:2,:],
                       im[1:H:2,0:W:2,:]), axis=2)
    #print(f'pack_raw,{out.shape = }')
    return out
```

![](https://borninfreedom.github.io/images/2025/02/sid/1.png)

åœ¨ç¼–ç éƒ¨åˆ†ï¼Œé€šè¿‡å¤šä¸ªmaxpool+conv+convçš„blockï¼Œå®ç°äº†ç‰¹å¾å›¾çš„é™é‡‡æ ·ã€‚
![](https://borninfreedom.github.io/images/2025/02/sid/2.png)


åœ¨è§£ç éƒ¨åˆ†ï¼Œé€šè¿‡å¤šä¸ªconv+conv+ConvTransposeçš„blockï¼Œå®ç°äº†ç‰¹å¾å›¾çš„ä¸Šé‡‡æ ·ã€‚
![](https://borninfreedom.github.io/images/2025/02/sid/3.png)


æœ€åï¼Œè¿˜æ˜¯é€šè¿‡ä½¿ç”¨kernel size=3, pad=1, stride=1çš„convä»¥åŠkernel=1ï¼Œpad=0ï¼Œstride=1çš„convï¼Œæ¥ä¿æŒç‰¹å¾å›¾å°ºå¯¸ä¸€è‡´ã€‚æœ€åé€šè¿‡ä¸€ä¸ªnn.pixel_shuffle(Depth2Space)å¾—åˆ°æœ€ç»ˆçš„RGBå‡ºå›¾ã€‚
![](https://borninfreedom.github.io/images/2025/02/sid/4.png)


## sidç½‘ç»œç»“æ„çš„å‡ ä¸ªé—®é¢˜

### 1. å¯¹äºå›¾åƒæ¢å¤çš„ï¼Œä¸ºä»€ä¹ˆå¯ä»¥ç”¨MaxPoolï¼Ÿ

åœ¨ **SeeInDark** è¿™ä¸ªç½‘ç»œä¸­ï¼Œ**MaxPool2dï¼ˆæœ€å¤§æ± åŒ–ï¼‰** çš„ä½¿ç”¨æ˜¯åˆç†çš„ï¼Œä¸»è¦åŸå› å¦‚ä¸‹ï¼š

---

#### **1. æœ€å¤§æ± åŒ–çš„ä½œç”¨**
**æœ€å¤§æ± åŒ–ï¼ˆMaxPool2dï¼‰** ä¸»è¦ç”¨äºï¼š
1. **é™ä½ç‰¹å¾å›¾çš„åˆ†è¾¨ç‡**ï¼ˆå‡å°è®¡ç®—é‡ï¼‰ã€‚
2. **å¢åŠ æ„Ÿå—é‡**ï¼Œæ•æ‰æ›´å¤§èŒƒå›´çš„ç‰¹å¾ã€‚
3. **å¢å¼ºç‰¹å¾çš„ç¨³å¥æ€§**ï¼ˆå‡å°‘å¯¹å¾®å°å™ªå£°çš„æ•æ„Ÿæ€§ï¼‰ã€‚

---

#### **2. ä¸ºä»€ä¹ˆå¯ä»¥ç”¨ MaxPoolï¼Ÿ**
##### **(1) æœ€å¤§æ± åŒ–ä¸ä¼šä¸¢å¤±å…³é”®ä¿¡æ¯**
åœ¨ **ä½å…‰å¢å¼ºä»»åŠ¡** ä¸­ï¼Œç½‘ç»œçš„ç›®æ ‡æ˜¯ä» **ä½å…‰å™ªå£°å›¾åƒ** ä¸­æå–å…³é”®ç‰¹å¾ï¼Œè€Œä¸æ˜¯å•çº¯åœ°ä¿ç•™æ‰€æœ‰åƒç´ ç»†èŠ‚ã€‚  
æœ€å¤§æ± åŒ–æœ‰åŠ©äºå»é™¤ **ç»†å¾®å™ªå£°**ï¼Œä¿ç•™ä¸»è¦ **äº®åº¦ä¿¡æ¯** å’Œ **è½®å»“ä¿¡æ¯**ã€‚

- ä¾‹å¦‚ï¼š
  - **å·ç§¯å±‚ï¼ˆConvï¼‰æå–ç‰¹å¾** â†’ **æœ€å¤§æ± åŒ–ï¼ˆMaxPoolï¼‰å»é™¤ä¸å¿…è¦çš„ç»†èŠ‚**ã€‚
  - è¿™æ ·å¯ä»¥ä½¿ç½‘ç»œå…³æ³¨ **å¤§å°ºåº¦çš„å…‰ç…§æ¨¡å¼**ï¼Œè€Œéå™ªå£°å¹²æ‰°ã€‚

---

##### **(2) æœ€å¤§æ± åŒ–èƒ½æé«˜ç½‘ç»œçš„æ„Ÿå—é‡**
**æ„Ÿå—é‡ï¼ˆReceptive Fieldï¼‰** æŒ‡çš„æ˜¯ **ç½‘ç»œæ¯ä¸ªç¥ç»å…ƒèƒ½å¤Ÿçœ‹åˆ°çš„è¾“å…¥åŒºåŸŸ**ã€‚  
åœ¨ä½å…‰å¢å¼ºä»»åŠ¡ä¸­ï¼š
- å±€éƒ¨åƒç´ å€¼é€šå¸¸ **å˜åŒ–è¾ƒå¤§**ï¼ˆç”±äºå™ªå£°ï¼‰ã€‚
- ä½† **å¤§åŒºåŸŸçš„äº®åº¦æ¨¡å¼**ï¼ˆå¦‚å…‰æºä½ç½®ã€ç‰©ä½“è¾¹ç•Œï¼‰è¾ƒç¨³å®šã€‚

æœ€å¤§æ± åŒ–å¯ä»¥ï¼š
- **æ‰©å¤§æ„Ÿå—é‡**ï¼Œè®©ç½‘ç»œå…³æ³¨æ›´å¤§åŒºåŸŸçš„å›¾åƒä¿¡æ¯ã€‚
- **å‡å°‘è®¡ç®—å¤æ‚åº¦**ï¼Œé™ä½æ˜¾å­˜éœ€æ±‚ï¼Œæé«˜è®­ç»ƒæ•ˆç‡ã€‚

---

##### **(3) U-Net ç»“æ„+è·³è·ƒè¿æ¥å¼¥è¡¥æ± åŒ–çš„ç¼ºç‚¹**
ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæœ€å¤§æ± åŒ–å¯èƒ½å¯¼è‡´ç»†èŠ‚ä¿¡æ¯çš„æŸå¤±ã€‚ç„¶è€Œï¼Œè¯¥ç½‘ç»œé‡‡ç”¨äº† **U-Net ç»“æ„**ï¼Œå…·æœ‰ **è·³è·ƒè¿æ¥ï¼ˆSkip Connectionï¼‰**ï¼š
- åœ¨è§£ç éƒ¨åˆ†ï¼Œ**ä½å±‚ç‰¹å¾ç›´æ¥è¿æ¥åˆ°é«˜å±‚**ï¼Œä¿ç•™äº† **å±€éƒ¨ç»†èŠ‚**ã€‚
- è¿™æ ·ï¼Œæœ€å¤§æ± åŒ–çš„ **å…¨å±€ç‰¹å¾æå–** èƒ½åŠ›å¯ä»¥ä¸è·³è·ƒè¿æ¥çš„ **å±€éƒ¨ä¿¡æ¯æ¢å¤** ç»“åˆï¼Œæ—¢å‡å°‘å™ªå£°ï¼Œåˆä¸ä¸¢å¤±å…³é”®ä¿¡æ¯ã€‚

---

##### **(4) å¯¹æ¯”å¹³å‡æ± åŒ–ï¼ˆAvgPoolï¼‰**
å¦ä¸€ç§æ± åŒ–æ–¹æ³•æ˜¯ **å¹³å‡æ± åŒ–ï¼ˆAvgPoolï¼‰**ï¼Œè®¡ç®—å±€éƒ¨åŒºåŸŸçš„å‡å€¼ï¼Œè€Œéæœ€å¤§å€¼ã€‚
- **MaxPool vs AvgPool å¯¹æ¯”**ï¼š
  | | **MaxPool** | **AvgPool** |
  |--|-----------|-----------|
  | è®¡ç®—æ–¹å¼ | å–æœ€å¤§å€¼ | è®¡ç®—å‡å€¼ |
  | é€‚ç”¨äº | çº¹ç†ã€è¾¹ç¼˜æ£€æµ‹ | å¹³æ»‘ã€æ¨¡ç³Š |
  | æ•ˆæœ | é€‰æ‹©æœ€æ˜¾è‘—ç‰¹å¾ | å¯èƒ½ä¸¢å¤±å¯¹æ¯”åº¦ |

åœ¨ **ä½å…‰å¢å¼ºä»»åŠ¡** ä¸­ï¼Œå›¾åƒé€šå¸¸å¾ˆæš—ï¼Œå…³é”®ç»†èŠ‚ï¼ˆå¦‚äº®éƒ¨åŒºåŸŸï¼‰ç›¸å¯¹ç¨€å°‘ã€‚**MaxPool æ›´é€‚åˆæå–å…³é”®äº®éƒ¨ç‰¹å¾ï¼Œè€Œä¸ä¼šå¯¼è‡´æ¨¡ç³ŠåŒ–**ã€‚

---

#### **3. ç»“è®º**
**åœ¨ SeeInDark è¿™ç§ä½å…‰å¢å¼ºç½‘ç»œä¸­ï¼Œä½¿ç”¨ MaxPool2d æ˜¯åˆç†çš„ï¼Œä¸»è¦åŸå› æ˜¯ï¼š**
1. **å»é™¤å™ªå£°ï¼Œæé«˜ç¨³å¥æ€§**ï¼ˆé¿å…å¯¹ç»†å¾®å™ªå£°è¿‡åº¦æ•æ„Ÿï¼‰ã€‚
2. **æ‰©å¤§æ„Ÿå—é‡**ï¼ˆè®©ç½‘ç»œå…³æ³¨å¤§èŒƒå›´çš„äº®åº¦ä¿¡æ¯ï¼‰ã€‚
3. **å‡å°‘è®¡ç®—é‡ï¼Œæé«˜è®­ç»ƒæ•ˆç‡**ã€‚
4. **è·³è·ƒè¿æ¥å¼¥è¡¥äº†æœ€å¤§æ± åŒ–çš„ä¿¡æ¯æŸå¤±**ï¼Œèƒ½åœ¨è§£ç é˜¶æ®µæ¢å¤ç»†èŠ‚ã€‚

å› æ­¤ï¼Œæœ€å¤§æ± åŒ–åœ¨è¿™ä¸ªä»»åŠ¡ä¸­èƒ½æœ‰æ•ˆå¸®åŠ©æå–å…³é”®çš„äº®åº¦å’Œè¾¹ç¼˜ä¿¡æ¯ï¼Œæ˜¯åˆç†çš„è®¾è®¡é€‰æ‹©ã€‚


### 2. æœ€åé‡‡ç”¨nn.PixelShuffleæ¥å®ç°åˆ†è¾¨ç‡å¢å¼ºï¼Œç›¸æ¯”ä½¿ç”¨ConvTransposeæˆ–è€…å…¶ä»–æ–¹å¼ï¼Œæœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼Ÿ


åœ¨ **SeeInDark** ç½‘ç»œçš„æœ€åä¸€å±‚ä½¿ç”¨äº† `nn.PixelShuffle` è¿›è¡Œ **åˆ†è¾¨ç‡å¢å¼ºï¼ˆSuper-Resolutionï¼‰**ï¼Œè¿™æ˜¯ä¸€ä¸ª **åˆç†ä¸”é«˜æ•ˆ** çš„è®¾è®¡é€‰æ‹©ã€‚ç›¸æ¯”äº **è½¬ç½®å·ç§¯ï¼ˆConvTranspose2dï¼‰** æˆ– **æ’å€¼ï¼ˆInterpolationï¼‰**ï¼Œ`PixelShuffle` å…·æœ‰ä»¥ä¸‹å‡ ä¸ªæ˜¾è‘—çš„ä¼˜ç‚¹ï¼š

---

#### **1. ä»€ä¹ˆæ˜¯ PixelShuffleï¼Ÿ**
`nn.PixelShuffle(upscale_factor=2)` ä½œç”¨æ˜¯ï¼š
- **è¾“å…¥é€šé“æ•° = (ç›®æ ‡é€šé“æ•° Ã— upscale_factorÂ²)**
- **é€šé“ä¿¡æ¯è½¬æ¢ä¸ºç©ºé—´ä¿¡æ¯**ï¼Œä»è€Œ **æé«˜åˆ†è¾¨ç‡**ã€‚

ä¸¾ä¾‹ï¼š
- **è¾“å…¥ï¼š12 é€šé“ï¼ˆC=12ï¼‰Ã— H Ã— W**
- **è¾“å‡ºï¼š3 é€šé“ï¼ˆC=3ï¼‰Ã— 2H Ã— 2W**ï¼ˆRGB ä¸‰é€šé“å›¾åƒï¼‰

è®¡ç®—æ–¹å¼ï¼š
- 12 é€šé“çš„è¾“å…¥è¢«é‡æ–°æ’åˆ—ä¸º `3 Ã— (2Ã—2) = 12` ä¸ªåƒç´ å—ã€‚
- è¿™ä¸ªé‡æ’æ“ä½œç›´æ¥æ˜ å°„åˆ°æ›´é«˜åˆ†è¾¨ç‡çš„å›¾åƒï¼Œè€Œä¸éœ€è¦é¢å¤–è®¡ç®—ã€‚

---

#### **2. ä¸ºä»€ä¹ˆ PixelShuffle æ›´é€‚åˆè¿™ä¸ªä»»åŠ¡ï¼Ÿ**
##### **(1) é¿å…äº† Checkerboard Artifactsï¼ˆæ£‹ç›˜æ ¼ä¼ªå½±ï¼‰**
ç›¸æ¯” **è½¬ç½®å·ç§¯ï¼ˆConvTranspose2dï¼‰**ï¼Œ`PixelShuffle` **ä¸ä¼šäº§ç”Ÿæ£‹ç›˜æ ¼ä¼ªå½±ï¼ˆcheckerboard artifactsï¼‰**ã€‚

#### **æ£‹ç›˜æ ¼ä¼ªå½±çš„æ¥æº**
- **è½¬ç½®å·ç§¯ï¼ˆConvTranspose2dï¼‰** ç”±äº **è·¨æ­¥ï¼ˆstrideï¼‰å’Œå¡«å……ï¼ˆpaddingï¼‰**ï¼Œå¯èƒ½ä¼šå¯¼è‡´åƒç´ å€¼åœ¨ä¸Šé‡‡æ ·æ—¶åˆ†å¸ƒä¸å‡åŒ€ï¼Œå½¢æˆæ£‹ç›˜æ ¼ä¼ªå½±ã€‚
- **PixelShuffle** **ä»…é‡æ–°æ’åˆ—åƒç´ ï¼Œä¸å¼•å…¥é¢å¤–è®¡ç®—ï¼Œé¿å…äº†è¿™ä¸€é—®é¢˜**ã€‚

ğŸ’¡ **ç»“è®º**ï¼šPixelShuffle **å¤©ç„¶å¹³æ»‘ï¼Œæ²¡æœ‰ä¼ªå½±**ï¼Œé€‚ç”¨äº **ä½å…‰å¢å¼º** è¿™ç§å¯¹å›¾åƒè´¨é‡è¦æ±‚é«˜çš„ä»»åŠ¡ã€‚

---

##### **(2) æ›´é«˜æ•ˆçš„è®¡ç®—**
PixelShuffle **ä¸»è¦æ˜¯å¼ é‡é‡æ’ï¼ˆrearrange operationï¼‰**ï¼Œç›¸æ¯” **è½¬ç½®å·ç§¯ï¼ˆConvTranspose2dï¼‰** å’Œ **åŒçº¿æ€§æ’å€¼ï¼ˆBilinear Interpolationï¼‰**ï¼Œè®¡ç®—é‡æ›´å°ï¼š
- **ConvTranspose2d** éœ€è¦ **é¢å¤–çš„å·ç§¯è®¡ç®—**ã€‚
- **æ’å€¼ï¼ˆBilinear æˆ– Bicubicï¼‰** éœ€è¦ **æ’å€¼è®¡ç®—**ã€‚
- **PixelShuffle** åªæ˜¯ **reshape + permute**ï¼Œè®¡ç®—å¤æ‚åº¦ä½ï¼Œé€Ÿåº¦å¿«ã€‚

ğŸ’¡ **ç»“è®º**ï¼šPixelShuffle **é€Ÿåº¦æ›´å¿«ï¼Œè®¡ç®—é‡æ›´ä½ï¼Œæ›´èŠ‚çœæ˜¾å­˜**ã€‚

---

##### **(3) æ›´å¥½åœ°ä¿ç•™ç»†èŠ‚**
ä½å…‰å¢å¼ºä»»åŠ¡éœ€è¦ **å¢å¼ºé«˜é¢‘ä¿¡æ¯ï¼ˆå¦‚çº¹ç†ã€è¾¹ç¼˜ï¼‰**ï¼ŒPixelShuffle **æ¯”åŒçº¿æ€§æ’å€¼æ›´èƒ½ä¿ç•™ç»†èŠ‚**ï¼š
- **Bilinear/Bicubic Interpolation**ï¼šå¯¹æ•´ä¸ªå›¾åƒè¿›è¡Œæ’å€¼ï¼Œä¼šå¯¼è‡´é«˜é¢‘ç»†èŠ‚ä¸¢å¤±ï¼Œå›¾åƒå˜æ¨¡ç³Šã€‚
- **PixelShuffle**ï¼šç›´æ¥ä»ç½‘ç»œçš„ç‰¹å¾é€šé“ä¸­ **æå–å’Œé‡æ’é«˜åˆ†è¾¨ç‡ä¿¡æ¯**ï¼Œä¸ä¼šå¼•å…¥æ¨¡ç³Šã€‚

ğŸ’¡ **ç»“è®º**ï¼šPixelShuffle **åœ¨ä¿æŒé«˜é¢‘ç»†èŠ‚æ–¹é¢æ¯”æ’å€¼æ–¹æ³•æ›´ä¼˜**ã€‚

---

##### **(4) é€‚ç”¨äºè¶…åˆ†è¾¨ç‡ä»»åŠ¡**
PixelShuffle æœ€æ—©ç”¨äº **è¶…åˆ†è¾¨ç‡é‡å»ºï¼ˆSuper-Resolution, SRï¼‰**ï¼Œä¾‹å¦‚ï¼š
- **EDSRï¼ˆEnhanced Deep SRï¼‰**
- **SRResNet**
- **ESRGANï¼ˆSR-GANï¼‰**

SeeInDark éœ€è¦ **æå‡å›¾åƒäº®åº¦ï¼ŒåŒæ—¶å¢å¼ºç»†èŠ‚**ï¼Œä½¿ç”¨ PixelShuffle å¯ä»¥ **åœ¨æ”¾å¤§åˆ†è¾¨ç‡çš„åŒæ—¶æ¢å¤å›¾åƒè´¨é‡**ã€‚

ğŸ’¡ **ç»“è®º**ï¼šPixelShuffle **æ›´é€‚åˆå›¾åƒå¢å¼ºå’Œè¶…åˆ†è¾¨ç‡ä»»åŠ¡**ï¼Œæ¯”æ™®é€šçš„ `ConvTranspose2d` æ›´èƒ½ä¿ç•™ **ç²¾ç»†çº¹ç†**ã€‚

---

#### **3. PixelShuffle vs ConvTranspose2d vs Interpolation å¯¹æ¯”**
| æ–¹æ³• | **è®¡ç®—é‡** | **ç»†èŠ‚ä¿æŒ** | **ä¼ªå½±é£é™©** | **é€‚ç”¨åœºæ™¯** |
|------|-----------|--------------|--------------|--------------|
| **PixelShuffle** | âœ… ä½ | âœ… é«˜ï¼ˆæ¸…æ™°ï¼‰ | âœ… æ— æ£‹ç›˜æ ¼ | **è¶…åˆ†è¾¨ç‡ã€å»å™ªã€ä½å…‰å¢å¼º** |
| **ConvTranspose2d** | âŒ é«˜ | ğŸ”¶ å¯èƒ½ä¸¢å¤± | âŒ é«˜ï¼ˆæ£‹ç›˜æ ¼ï¼‰ | **ç”Ÿæˆå¯¹æŠ—ç½‘ç»œï¼ˆGANï¼‰ã€åˆ†å‰²ä»»åŠ¡** |
| **Bilinear Interpolation** | âœ… ä½ | âŒ ç»†èŠ‚ä¸¢å¤± | âœ… æ—  | **ä¸€èˆ¬æ€§æ”¾å¤§ï¼ˆå¦‚ CNN æœ€åå±‚ï¼‰** |

---

#### **4. ç»“è®º**
SeeInDark é‡‡ç”¨ **PixelShuffle** è¿›è¡Œåˆ†è¾¨ç‡å¢å¼ºæ˜¯ä¸€ä¸ª **ä¼˜é›…çš„è®¾è®¡**ï¼Œç›¸æ¯” `ConvTranspose2d` æˆ–æ’å€¼æ–¹æ³•ï¼Œå®ƒçš„ä¸»è¦ä¼˜åŠ¿æ˜¯ï¼š
1. **é¿å…æ£‹ç›˜æ ¼ä¼ªå½±**ï¼ˆæ¯” `ConvTranspose2d` æ›´ç¨³å®šï¼‰ã€‚
2. **è®¡ç®—é‡æ›´ä½ï¼Œæ›´å¿«**ï¼ˆä»…éœ€ reshape æ“ä½œï¼‰ã€‚
3. **æ›´å¥½åœ°ä¿ç•™ç»†èŠ‚**ï¼ˆæ¯”åŒçº¿æ€§æ’å€¼æ›´æ¸…æ™°ï¼‰ã€‚
4. **è¶…åˆ†è¾¨ç‡ä»»åŠ¡çš„æ ‡å‡†åšæ³•**ï¼ˆæ›´é€‚åˆä½å…‰å¢å¼ºä»»åŠ¡ï¼‰ã€‚

ç»¼ä¸Šï¼ŒPixelShuffle **åœ¨ SeeInDark ç½‘ç»œä¸­çš„ä½¿ç”¨æ˜¯ä¸€ä¸ªèªæ˜çš„é€‰æ‹©**ï¼Œåœ¨ä¿æŒé«˜è´¨é‡è¾“å‡ºçš„åŒæ—¶ï¼Œç¡®ä¿äº†è®¡ç®—æ•ˆç‡å’Œç¨³å®šæ€§ã€‚ ğŸš€


# äºŒã€ä½¿ç”¨gradioåˆ›å»ºUIçš„æ–¹æ³•

æˆ‘ä»¬ä»¥å±•ç¤ºçš„UIä»£ç ä¸ºä¾‹å±•å¼€è¯´æ˜ï¼š

```python
class GradioUI:
    def __init__(self, image_processor):
        self.image_processor = image_processor
        self.demo = self.create_ui()

    def create_ui(self):
        with gr.Blocks() as demo:
            gr.Markdown("# The Image Toolbox Is All You Need")
            demo.css = """
            #batch-process-button {
                background-color: #007AFF;
                color: white;
            }
            """
            with gr.Tabs() as tabs:
                self.create_night_enhance_tab()
                self.create_exif_parser_tab()
                self.create_image_resize_tab()
        return demo

    def create_night_enhance_tab(self):
        with gr.TabItem("ææš—å¤œæ™¯å¢å¼º", id="night_enhance"):
            mode = gr.Radio(["å•ä¸ªæ–‡ä»¶å¤„ç†", "æ‰¹é‡å¤„ç†"], label="æ¨¡å¼é€‰æ‹©", value="å•ä¸ªæ–‡ä»¶å¤„ç†")
            single_file_row, batch_file_row = self.create_single_file_ui(), self.create_batch_file_ui()
            mode.change(self.update_ui_mode, inputs=[mode], outputs=[single_file_row, batch_file_row])

    def create_single_file_ui(self):
        with gr.Row(visible=True) as single_file_row:
            with gr.Column():
                with gr.Row():
                    input_image = gr.File(label="è¾“å…¥RAWå›¾åƒæ–‡ä»¶")
                    output_image = gr.Image(label="è¾“å‡ºå›¾åƒ")
                with gr.Row():
                    ratio_single_bar = gr.Slider(label="æäº®å¼ºåº¦", minimum=0, maximum=300, value=100, step=10)
                with gr.Row():
                    process_button_single = gr.Button("å¤„ç†", elem_id="batch-process-button")
                with gr.Row():
                    error_message_box = gr.Textbox(label="é”™è¯¯æç¤º", value="", visible=False, interactive=False)
                with gr.Row():
                    gr.Markdown("""
                    <span style='font-size: 18px;'></span>  \n
                    <span style='font-size: 18px;'>è¯·ä¼ å…¥RAWå›¾</span>  \n
                    <span style='font-size: 18px;'>å½“å‰ç®—æ³•åªèƒ½å¤„ç†è‚‰çœ¼çœ‹èµ·æ¥ææš—çš„ç…§ç‰‡ï¼Œå¦‚æœå¤„ç†æ­£å¸¸æ›å…‰çš„å›¾ç‰‡ï¼Œå¤„ç†åå°±ä¼šè¿‡æ›ã€‚</span>
                    """)
                examples_data = [
                    ["assets/input_0475.png", 300, "assets/out_0475.png"],
                    ["assets/input_0139.png", 1, "assets/out_0139.png"]
                ]
                with gr.Row():
                    gr.Examples(examples=examples_data, inputs=[input_image, ratio_single_bar, output_image], label="ç¤ºä¾‹è¡¨æ ¼")
                process_button_single.click(
                    self.validate_and_process_single,
                    inputs=[input_image, ratio_single_bar],
                    outputs=[output_image, error_message_box, error_message_box]
                )
        return single_file_row

    def create_batch_file_ui(self):
        with gr.Row(visible=False) as batch_file_row:
            with gr.Column():
                with gr.Row(scale=1):
                    input_folder = gr.File(label="é€‰æ‹©è¾“å…¥æ–‡ä»¶å¤¹ï¼Œé€‰æ‹©åˆ°æœ€åº•å±‚æ–‡ä»¶å¤¹å³å¯ï¼Œä¸è¦é€‰æ‹©å•ä¸ªæ–‡ä»¶", file_count="directory")
                with gr.Row(scale=1):    
                    output_folder = gr.Dropdown(choices=self.list_non_hidden_files(os.path.expanduser("~/Pictures")), label="é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹")
                with gr.Row():    
                    ratio_batch_bar = gr.Slider(label="æäº®å¼ºåº¦", minimum=1, maximum=300, value=100, step=1)
                with gr.Row():
                    batch_process_button = gr.Button("å¤„ç†", elem_id="batch-process-button")
                with gr.Row():
                    error_message_box = gr.Textbox(label="æç¤º", value="", visible=True, interactive=False)
                progress_display = gr.Textbox(label="å¤„ç†è¿›åº¦", interactive=False)
                with gr.Row():
                    input_image_display = gr.Image(label="å½“å‰è¾“å…¥å›¾åƒ", interactive=False)
                    output_image_display = gr.Image(label="å½“å‰è¾“å‡ºå›¾åƒ", interactive=False)
                batch_process_button.click(
                    self.image_processor.enhance_night_image_batch,
                    inputs=[input_folder, output_folder, ratio_batch_bar],
                    outputs=[error_message_box, input_image_display, output_image_display, progress_display],
                    queue=True
                )
        return batch_file_row

    def create_exif_parser_tab(self):
        with gr.TabItem("EXIFè§£æ", id="exif_parser"):
            gr.Markdown("EXIFè§£æåŠŸèƒ½å¼€å‘ä¸­...")

    def create_image_resize_tab(self):
        with gr.TabItem("å›¾åƒresize", id="image_resize"):
            gr.Markdown("å›¾åƒresizeåŠŸèƒ½å¼€å‘ä¸­...")

    @staticmethod
    def list_non_hidden_files(path):
        """åˆ—å‡ºæŒ‡å®šè·¯å¾„ä¸‹çš„ééšè—æ–‡ä»¶å’Œæ–‡ä»¶å¤¹"""
        if not os.path.exists(path):
            return []
        return [os.path.join(path, f) for f in os.listdir(path) if not f.startswith('.')]

    @staticmethod
    def update_ui_mode(selected_mode):
        if selected_mode == "å•ä¸ªæ–‡ä»¶å¤„ç†":
            return gr.update(visible=True), gr.update(visible=False)
        else:
            return gr.update(visible=False), gr.update(visible=True)

    def validate_and_process_single(self, file, ratio):
        """éªŒè¯æ–‡ä»¶æ ¼å¼å¹¶å¤„ç†å•å¼ å›¾åƒ"""
        allowed_extensions = {".raw", ".dng", ".arw", ".nef"}
        if file is None:
            return None, "è¯·ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ã€‚", gr.update(visible=True)
        _, ext = os.path.splitext(file.name)
        if ext.lower() not in allowed_extensions:
            return None, f"æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š{ext}ã€‚è¯·ä¸Šä¼ RAWæ ¼å¼æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼š.raw, .dngï¼‰ã€‚", gr.update(visible=True)
        result = self.image_processor.enhance_night_image_single(file, ratio)
        return result, "", gr.update(visible=False)

    # def validate_and_process_batch(self, input_folder, output_folder, ratio):
    #     """éªŒè¯æ–‡ä»¶æ ¼å¼å¹¶å¤„ç†æ‰¹é‡å›¾åƒ"""
    #     #return self.image_processor.enhance_night_image_batch(input_folder, output_folder, ratio)
    #     error_message, input_image, output_image, progress_dis = self.image_processor.enhance_night_image_batch(input_folder, output_folder, ratio)
    #     return  error_message, input_image, output_image, progress_dis

    def launch(self):
        self.demo.launch(share=False)

# ä¸»å‡½æ•°
def main():
    device = DeviceChecker.get_device()
    image_processor = NightEnhancer(device)
    gradio_ui = GradioUI(image_processor)
    gradio_ui.launch()

if __name__ == "__main__":
    main()
```


## **Gradio UI ç¼–ç¨‹æ–¹æ³•æ€»ç»“**

Gradio æ˜¯ä¸€ä¸ªç”¨äºå¿«é€Ÿæ„å»º Web ç•Œé¢çš„ Python åº“ï¼Œé€‚ç”¨äºæœºå™¨å­¦ä¹ æ¨¡å‹çš„å¯è§†åŒ–ä¸äº¤äº’ã€‚æœ¬ä»£ç å±•ç¤ºäº† Gradio UI çš„å®Œæ•´å¼€å‘æµç¨‹ï¼Œæ¶µç›– **ç»„ä»¶ã€äº¤äº’é€»è¾‘ã€å›è°ƒå‡½æ•°** åŠ **å¤šé¡µé¢ç®¡ç†**ã€‚ä»¥ä¸‹æ˜¯ Gradio UI ç¼–ç¨‹çš„ä¸»è¦æ–¹æ³•æ€»ç»“ï¼š

---

### **1. Gradio UI çš„åŸºæœ¬ç»“æ„**
Gradio çš„ UI ç”± **Blocks**ã€**Tabs**ã€**Components** ç»„æˆï¼Œå¹¶é€šè¿‡ **äº‹ä»¶ç»‘å®š** è¿æ¥é€»è¾‘ã€‚

#### **(1) Blocks ä½œä¸º UI å®¹å™¨**
åœ¨ `GradioUI` ç±»ä¸­ï¼Œæ‰€æœ‰ UI ç»„ä»¶éƒ½æ˜¯åœ¨ `gr.Blocks()` ä½œç”¨åŸŸå†…åˆ›å»ºçš„ï¼š
```python
with gr.Blocks() as demo:
```
- `Blocks` æ˜¯ **Gradio çš„é«˜çº§ UI å®¹å™¨**ï¼Œæ”¯æŒ **å¤šåˆ—ã€å¤šè¡Œã€ç»„ä»¶äº¤äº’**ã€‚
- `Tabs` ç”¨äºåˆ›å»ºå¤šé¡µé¢ç•Œé¢ï¼Œå¦‚ "å¤œæ™¯å¢å¼º"ã€"EXIFè§£æ" ç­‰ã€‚

---

### **2. ä½¿ç”¨ Tabs ç»„ç»‡å¤šé¡µé¢ UI**
åœ¨ `create_ui()` æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ `gr.Tabs()` åˆ›å»ºå¤šä¸ªé€‰é¡¹å¡ï¼š
```python
with gr.Tabs() as tabs:
    self.create_night_enhance_tab()
    self.create_exif_parser_tab()
    self.create_image_resize_tab()
```
æ¯ä¸ªé€‰é¡¹å¡å¯¹åº”ä¸€ä¸ªåŠŸèƒ½æ¨¡å—ï¼Œä½¿å¾— UI **å±‚æ¬¡æ¸…æ™°**ï¼Œé€‚åˆå¤æ‚çš„åº”ç”¨ã€‚

---

### **3. UI ç»„ä»¶çš„ä½¿ç”¨**
Gradio æä¾›å¤šç§ **è¾“å…¥è¾“å‡ºç»„ä»¶**ï¼Œåœ¨ `create_single_file_ui()` å’Œ `create_batch_file_ui()` æ–¹æ³•ä¸­ä½¿ç”¨äº†å¤šä¸ª UI ç»„ä»¶ï¼š

#### **(1) è¾“å…¥ç»„ä»¶**
```python
input_image = gr.File(label="è¾“å…¥RAWå›¾åƒæ–‡ä»¶")
ratio_single_bar = gr.Slider(label="æäº®å¼ºåº¦", minimum=0, maximum=300, value=100, step=10)
mode = gr.Radio(["å•ä¸ªæ–‡ä»¶å¤„ç†", "æ‰¹é‡å¤„ç†"], label="æ¨¡å¼é€‰æ‹©", value="å•ä¸ªæ–‡ä»¶å¤„ç†")
```
- `gr.File()` å…è®¸ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ã€‚
- `gr.Slider()` åˆ›å»ºæ»‘å—è°ƒæ•´å‚æ•°ã€‚
- `gr.Radio()` åˆ›å»ºå•é€‰æŒ‰é’®ã€‚

#### **(2) è¾“å‡ºç»„ä»¶**
```python
output_image = gr.Image(label="è¾“å‡ºå›¾åƒ")
error_message_box = gr.Textbox(label="é”™è¯¯æç¤º", value="", visible=False, interactive=False)
```
- `gr.Image()` æ˜¾ç¤ºå¤„ç†åçš„å›¾ç‰‡ã€‚
- `gr.Textbox()` ç”¨äºæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€‚

#### **(3) äº¤äº’ç»„ä»¶**
```python
process_button_single = gr.Button("å¤„ç†", elem_id="batch-process-button")
```
- `gr.Button()` è§¦å‘å›¾åƒå¤„ç†é€»è¾‘ã€‚

---

### **4. ç»„ä»¶äº¤äº’ï¼ˆäº‹ä»¶ç»‘å®šï¼‰**
äº‹ä»¶ç»‘å®šæ˜¯ **Gradio UI çš„æ ¸å¿ƒ**ï¼Œå…è®¸ä¸åŒç»„ä»¶ååŒå·¥ä½œã€‚æœ¬ä»£ç ä¸­ï¼Œ`mode.change()` ç»‘å®šäº†å•é€‰æ¨¡å¼çš„ **çŠ¶æ€æ›´æ–°**ï¼š
```python
mode.change(self.update_ui_mode, inputs=[mode], outputs=[single_file_row, batch_file_row])
```
- å½“ `mode` å˜åŒ–æ—¶ï¼Œè°ƒç”¨ `update_ui_mode()`ï¼Œæ ¹æ®æ¨¡å¼åˆ‡æ¢ **å•æ–‡ä»¶ / æ‰¹é‡ UI** çš„å¯è§æ€§ã€‚

**äº‹ä»¶ç»‘å®šçš„é€šç”¨æ ¼å¼ï¼š**
```python
ç»„ä»¶.äº‹ä»¶(å›è°ƒå‡½æ•°, inputs=[è¾“å…¥ç»„ä»¶], outputs=[è¾“å‡ºç»„ä»¶])
```

---

### **5. å¤„ç†é€»è¾‘ä¸éªŒè¯**
åœ¨ `validate_and_process_single()` ä¸­ï¼Œè¿›è¡Œ **æ–‡ä»¶æ ¼å¼æ£€æŸ¥**ï¼Œå¹¶è°ƒç”¨ `image_processor` è¿›è¡Œå›¾åƒå¤„ç†ï¼š
```python

process_button_single.click(
    self.validate_and_process_single,
    inputs=[input_image, ratio_single_bar],
    outputs=[output_image, error_message_box, error_message_box]
)

åœ¨è¿™ä¸ªprocess_button_singleçš„æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸Šï¼Œç»‘å®šçš„æ˜¯self.validate_and_process_singleå‡½æ•°ï¼Œ`inputs=[input_image, ratio_single_bar]`è¡¨ç¤ºself.validate_and_process_singleå‡½æ•°æ¥æ”¶ä¸¤ä¸ªinputï¼Œä¸€ä¸ªæ˜¯input_imageï¼Œä¸€ä¸ªæ˜¯ratio_single_barã€‚`outputs=[output_image, error_message_box, error_message_box]`è¡¨ç¤ºself.validate_and_process_singleçš„è¿”å›å€¼ä¸gradioçš„`output_image, error_message_box, error_message_box`è¿™ä¸‰ä¸ªç»„ä»¶ç»‘å®šï¼Œå‡½æ•°çš„è¿”å›å€¼åŒæ­¥åˆ°ç»„ä»¶çš„updateä¸Šé¢ã€‚

def validate_and_process_single(self, file, ratio):
    allowed_extensions = {".raw", ".dng", ".arw", ".nef"}
    if file is None:
        return None, "è¯·ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ã€‚", gr.update(visible=True)
    _, ext = os.path.splitext(file.name)
    if ext.lower() not in allowed_extensions:
        return None, f"æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š{ext}ã€‚è¯·ä¸Šä¼ RAWæ ¼å¼æ–‡ä»¶ã€‚", gr.update(visible=True)
    result = self.image_processor.enhance_night_image_single(file, ratio)
    return result, "", gr.update(visible=False)
```
- æ£€æŸ¥ `file` æ˜¯å¦ä¸ºç©ºã€‚
- ç¡®ä¿æ–‡ä»¶æ ¼å¼ä¸º RAWï¼ˆ`.dng`, `.arw`, `.nef`ï¼‰ã€‚
- å¤„ç†å®Œæˆåè¿”å› **è¾“å‡ºå›¾åƒ** å’Œ **é”™è¯¯ä¿¡æ¯**ã€‚

---

### **6. ä½¿ç”¨yieldè®©ç»„ä»¶äº¤äº’ï¼ˆäº‹ä»¶ç»‘å®šï¼‰å®æ—¶æ›´æ–°**

åœ¨ç¬¬5æ¡ï¼Œç»„ä»¶çš„æ›´æ–°é€šè¿‡validate_and_process_singleå‡½æ•°çš„returnæ¥æŠŠoutputçš„ç»“æœåŒæ­¥åˆ°gradioçš„UIç»„ä»¶ä¸Šï¼Œä½†æ˜¯è¿™æ ·æœ‰ä¸ªç¼ºç‚¹ï¼Œåªæœ‰å½“å‡½æ•°å…¨éƒ¨è¿è¡Œå®Œæˆï¼Œreturnç»“æœåï¼Œgradioçš„UIç»„ä»¶æ‰èƒ½æ›´æ–°ã€‚å¯¹äºå•ä¸ªæ–‡ä»¶å¤„ç†ï¼Œè¿™æ ·æ˜¯å¯ä»¥çš„ã€‚ä½†æ˜¯å¦‚æœæ˜¯æ‰¹é‡æ–‡ä»¶å¤„ç†ï¼Œæˆ‘ä»¬æƒ³åœ¨å¤šä¸ªæ–‡ä»¶å¤„ç†è¿‡ç¨‹ä¸­çœ‹åˆ°æ­£åœ¨å¤„ç†ç¬¬å‡ ä¸ªæ–‡ä»¶çš„logä¿¡æ¯ï¼Œä½¿ç”¨returnå°±ä¸åˆé€‚äº†ï¼Œreturnåå‡½æ•°å°±è¿è¡Œå®Œæˆäº†ã€‚æ‰€ä»¥ä½¿ç”¨yieldå¯ä»¥å®Œæˆè¿™ä¸ªéœ€æ±‚ã€‚

```python
batch_process_button.click(
    self.image_processor.enhance_night_image_batch,
    inputs=[input_folder, output_folder, ratio_batch_bar],
    outputs=[error_message_box, input_image_display, output_image_display, progress_display],
    queue=True
)

#åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æŠŠgradioçš„UIä¸Šçš„æ‰¹é‡å¤„ç†çš„æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼Œç»‘å®šåˆ°`self.image_processor.enhance_night_image_batch`å‡½æ•°ä¸Šã€‚å‡½æ•°çš„å®ç°ä¸ºï¼š

def enhance_night_image_batch(self, input_folder, output_folder, ratio):
    """æ‰¹é‡å¢å¼ºå¤œæ™¯å›¾åƒ"""
    allowed_extensions = {".raw", ".dng", ".arw", ".nef"}
    total_files = len(input_folder)
    for idx, cur_file in enumerate(input_folder):
        cur_file_path = cur_file
        if cur_file_path is None:
            yield "å½“å‰æ–‡ä»¶ä¸å­˜åœ¨", None, None, f"è¿›åº¦ï¼š{idx}/{total_files} å·²å¤„ç†"
            continue

        cur_file_name, ext = os.path.splitext(cur_file_path.name)
        if ext.lower() not in allowed_extensions:
            yield f"æ–‡ä»¶ï¼š{cur_file_path.name}ä¸æ˜¯rawæ–‡ä»¶ï¼Œç•¥è¿‡å¤„ç†ã€‚è¯·ä½¿ç”¨rawæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼š.raw, .dngï¼‰ã€‚", None, None, f"è¿›åº¦ï¼š{idx}/{total_files} å·²å¤„ç†"
            continue

        try:
            raw = rawpy.imread(cur_file_path)
            im = raw.postprocess(use_camera_wb=True, half_size=False, no_auto_bright=True, output_bps=16)
            scale_full = np.expand_dims(np.float32(im / 65535.0), axis=0) * 1
            scale_full = scale_full[0, :, :, :]
            processed_image = (scale_full * 255).astype('uint8')
            result = self.enhance_night_image_single(cur_file_path, ratio)
            output_folder_path = os.path.join(output_folder, cur_file_name + "_enhanced.png")
            if result.dtype != np.uint8:
                result = (result * 255).astype(np.uint8)
            Image.fromarray(result, 'RGB').save(output_folder_path)
            yield f"æ–‡ä»¶{cur_file_path.name}å¤„ç†å®Œæˆï¼Œå·²ä¿å­˜åˆ°{output_folder_path}", processed_image, result, f"è¿›åº¦ï¼š{idx}/{total_files} å·²å¤„ç†"
        except Exception as e:
            yield f"å¤„ç†æ–‡ä»¶ {cur_file_path.name} æ—¶å‘ç”Ÿé”™è¯¯,ç•¥è¿‡å¤„ç†ï¼Œé”™è¯¯ä¿¡æ¯ï¼š{e}", None, None, f"è¿›åº¦ï¼š{idx}/{total_files} å·²å¤„ç†"
            continue

    yield "å¤„ç†å®Œæˆ", None, None, f"è¿›åº¦ï¼š{total_files}/{total_files} å·²å¤„ç†"

```

åœ¨enhance_night_image_batchå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡yieldæ¥è¿”å›å„ç»„ä»¶çš„å€¼ã€‚ä¾‹å¦‚`yield f"æ–‡ä»¶{cur_file_path.name}å¤„ç†å®Œæˆï¼Œå·²ä¿å­˜åˆ°{output_folder_path}", processed_image, result, f"è¿›åº¦ï¼š{idx}/{total_files} å·²å¤„ç†"`è¿™å¥ï¼Œæ ¹æ®
```python
batch_process_button.click(
    self.image_processor.enhance_night_image_batch,
    inputs=[input_folder, output_folder, ratio_batch_bar],
    outputs=[error_message_box, input_image_display, output_image_display, progress_display],
    queue=True
)
```
çš„äº‹ä»¶ç»‘å®šå¯çŸ¥ï¼Œyieldçš„ç¬¬ä¸€ä¸ªè¿”å›å€¼`f"æ–‡ä»¶{cur_file_path.name}å¤„ç†å®Œæˆï¼Œå·²ä¿å­˜åˆ°{output_folder_path}"`å¯¹åº”çš„æ˜¯error_message_boxçš„ä¿¡æ¯æ›´æ–°ï¼Œ `processed_image`å¯¹åº”çš„æ˜¯input_image_displayçš„UIä¿¡æ¯æ›´æ–°ï¼Œå…¶ä»–åŒç†ã€‚é€šè¿‡`yield`ï¼Œå°±ä¸ç”¨ç­‰å‡½æ•°å…¨éƒ¨è¿è¡Œå®Œæˆåæ›´æ–°UIçš„ç»„ä»¶äº†ï¼Œå‡½æ•°è¿è¡Œè¿‡ç¨‹ä¸­å°±å¯ä»¥å®ç°UIçš„æ›´æ–°ã€‚

---


### **7. æ‰¹é‡ä»»åŠ¡ & è¿›åº¦æ›´æ–°**
å¯¹äºæ‰¹é‡ä»»åŠ¡ï¼Œ`create_batch_file_ui()` ä¸­å®ç°ï¼š
```python
batch_process_button.click(
    self.image_processor.enhance_night_image_batch,
    inputs=[input_folder, output_folder, ratio_batch_bar],
    outputs=[error_message_box, input_image_display, output_image_display, progress_display],
    queue=True  # å…è®¸ä»»åŠ¡æ’é˜Ÿæ‰§è¡Œ
)
```
- **`queue=True`** ä½¿ä»»åŠ¡æ”¯æŒæ’é˜Ÿï¼Œé€‚ç”¨äº **é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡**ã€‚
- å¤„ç†è¿‡ç¨‹ä¸­ï¼Œ`progress_display` æ˜¾ç¤ºå½“å‰è¿›åº¦ã€‚

---

### **8. å¯åŠ¨ Gradio UI**
`launch()` æ–¹æ³•ç”¨äºå¯åŠ¨ Web ç•Œé¢ï¼š
```python
def launch(self):
    self.demo.launch(share=False)
```
- `share=False` ä»…åœ¨æœ¬åœ°è¿è¡Œï¼Œè®¾ç½®ä¸º `True` å¯è·å–å…¬ç½‘é“¾æ¥ã€‚

---

### **æ€»ç»“**
Gradio UI ç¼–ç¨‹çš„ **æ ¸å¿ƒæ€æƒ³**ï¼š
1. **ä½¿ç”¨ `Blocks` ç»„ç»‡ UI ç»“æ„**ï¼ˆæ”¯æŒå¤šé¡µé¢ï¼‰ã€‚
2. **ä½¿ç”¨ `Tabs` åˆ’åˆ†åŠŸèƒ½æ¨¡å—**ï¼ˆå¦‚â€œå¤œæ™¯å¢å¼ºâ€ã€â€œEXIFè§£æâ€ï¼‰ã€‚
3. **ä½¿ç”¨ `Radio` + `Row` æ§åˆ¶ UI æ˜¾ç¤ºçŠ¶æ€**ï¼ˆå•ä¸ªæ–‡ä»¶ vs æ‰¹é‡æ¨¡å¼ï¼‰ã€‚
4. **ç»„ä»¶äº¤äº’ï¼ˆäº‹ä»¶ç»‘å®šï¼‰**ï¼ˆæŒ‰é’®è§¦å‘å¤„ç†ï¼Œå•é€‰æ¡†åˆ‡æ¢æ¨¡å¼ï¼‰ã€‚
5. **ä½¿ç”¨ `queue=True` æ”¯æŒæ‰¹é‡ä»»åŠ¡æ’é˜Ÿ**ï¼ˆé€‚ç”¨äºé•¿æ—¶é—´ä»»åŠ¡ï¼‰ã€‚
6. **ä½¿ç”¨ `launch()` å¯åŠ¨ Web ç•Œé¢**ã€‚

æœ¬ä»£ç å±•ç¤ºäº† **å®Œæ•´çš„ Gradio UI ç»“æ„**ï¼Œé€‚ç”¨äº **å›¾åƒå¤„ç†ã€æœºå™¨å­¦ä¹ æ¨¡å‹éƒ¨ç½²** ç­‰åº”ç”¨ã€‚ğŸš€